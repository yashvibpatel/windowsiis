name: Deploy to IIS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout code
      uses: actions/checkout@v4

    # 2️⃣ Grant NETWORK SERVICE full control to wwwroot
    - name: Grant IIS permissions
      run: |
        $path = "C:\inetpub\wwwroot"
        $acl = Get-Acl $path
        $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("NETWORK SERVICE","FullControl","ContainerInherit,ObjectInherit","None","Allow")
        $acl.SetAccessRule($rule)
        Set-Acl $path $acl
      shell: powershell

    # 3️⃣ Remove default IIS files
    - name: Remove default IIS files
      run: Remove-Item -Path "C:\inetpub\wwwroot\*" -Recurse -Force
      shell: powershell

    # 4️⃣ Copy repository files to wwwroot
    - name: Deploy files to wwwroot
      run: Copy-Item -Path "$env:GITHUB_WORKSPACE\*" -Destination "C:\inetpub\wwwroot" -Recurse -Force
      shell: powershell

    # 5️⃣ Optional: Recycle DefaultAppPool
    - name: Recycle IIS App Pool
      run: |
        Import-Module WebAdministration
        Restart-WebAppPool DefaultAppPool
      shell: powershell

    # 6️⃣ Test site
    - name: Test site
      run: Invoke-WebRequest http://localhost
      shell: powershell
