name: Deploy to IIS

on:
  push:
    branches: ["main"]  # Trigger deployment on push to main

jobs:
  deploy:
    runs-on: self-hosted  # Your EC2 self-hosted runner
    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Remove old IIS files
      - name: Remove old IIS files
        run: Remove-Item -Recurse -Force "C:\inetpub\wwwroot\*" -ErrorAction SilentlyContinue
        shell: powershell

      # Step 3: Copy all files from repo to IIS
      - name: Copy new files to IIS
        run: Copy-Item -Path "$env:GITHUB_WORKSPACE\*" -Destination "C:\inetpub\wwwroot" -Recurse -Force
        shell: powershell

      # Step 4: Recycle IIS App Pool (Admin required)
      - name: Recycle IIS App Pool
        run: |
          Start-Process powershell -Verb runAs -ArgumentList 'Import-Module WebAdministration; Restart-WebAppPool DefaultAppPool'
        shell: powershell
